<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Form Buku - Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --primary: #4361ee; --light-bg: #f4f6f8; --card-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--light-bg); color: #2b2d42; }
        
        .navbar { background: #fff; box-shadow: 0 2px 15px rgba(0,0,0,0.03); padding: 1rem 0; }
        .navbar-brand { font-weight: 800; color: var(--primary) !important; font-size: 1.5rem; }
        .nav-link { font-weight: 600; color: #8d99ae !important; margin: 0 10px; transition: 0.3s; }
        .nav-link.active { color: var(--primary) !important; }

        .card-custom { border: none; border-radius: 16px; background: white; box-shadow: var(--card-shadow); overflow: hidden; }
        .card-header-custom { background: #fff; border-bottom: 1px solid #f0f0f0; padding: 20px 30px; }
        
        .form-label { font-weight: 600; font-size: 0.9rem; color: #4b5563; margin-bottom: 8px; }
        .form-control { border-radius: 8px; border: 1px solid #e2e8f0; padding: 10px 15px; font-size: 0.95rem; }
        .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.1); }
        
        .btn-primary-soft { background: var(--primary); color: white; font-weight: 600; border: none; padding: 10px 25px; border-radius: 8px; transition: 0.3s; }
        .btn-primary-soft:hover { background: #3f37c9; transform: translateY(-2px); }
        
        .btn-secondary-soft { background: #f1f5f9; color: #64748b; font-weight: 600; border: none; padding: 10px 25px; border-radius: 8px; }
        .btn-secondary-soft:hover { background: #e2e8f0; color: #475569; }

        .isbn-box { background: #eff6ff; border: 1px dashed #bfdbfe; border-radius: 12px; padding: 20px; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand" href="/admin/dashboard"><i class="fas fa-book-open me-2"></i>Library<span class="text-dark">App</span></a>
            <div class="navbar-nav me-auto ms-4">
                <a class="nav-link" href="/admin/dashboard">Dashboard</a>
                <a class="nav-link active" href="/admin/buku">Data Buku</a>
                <a class="nav-link" href="/admin/peminjaman">Transaksi</a>
                <a class="nav-link" href="/admin/anggota">Anggota</a>
            </div>
        </div>
    </nav>

    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card-custom">
                    <div class="card-header-custom">
                        <h4 class="mb-0 fw-bold">
                            <i class="fas fa-pen-nib text-primary me-2"></i>
                            <span th:text="${buku.id == null ? 'Tambah Buku Baru' : 'Edit Data Buku'}">Form Buku</span>
                        </h4>
                    </div>
                    <div class="card-body p-4 p-md-5">

                        <form th:action="@{/admin/buku/simpan}" th:object="${buku}" method="post" enctype="multipart/form-data">
                            
                            <input type="hidden" th:field="*{id}">
                            <input type="hidden" th:field="*{gambar}">
                            <input type="hidden" th:field="*{sedangDipinjam}">
                            <input type="hidden" th:field="*{isbn}" th:if="${buku.id != null}">

                            <div class="isbn-box mb-4" th:if="${buku.id == null}">
                                <label class="form-label text-primary"><i class="fas fa-magic me-2"></i>Isi Otomatis via ISBN</label>
                                <div class="input-group">
                                    <input type="text" id="inputIsbn" th:field="*{isbn}" class="form-control" placeholder="Masukan ISBN (Contoh: 9786020332940)">
                                    <button type="button" class="btn btn-dark" onclick="cariBuku()">
                                        <i class="fas fa-search"></i> Cari
                                    </button>
                                </div>
                                <small class="text-muted mt-2 d-block">Data buku akan terisi otomatis dari Google Books.</small>
                            </div>

                            <div class="mb-4">
                                <label class="form-label">Judul Buku</label>
                                <input type="text" id="inputJudul" th:field="*{judul}" class="form-control" required placeholder="Judul lengkap buku...">
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-4">
                                    <label class="form-label">Penulis</label>
                                    <input type="text" id="inputPenulis" th:field="*{penulis}" class="form-control" required>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <label class="form-label">Penerbit</label>
                                    <input type="text" id="inputPenerbit" th:field="*{penerbit}" class="form-control" required>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-4">
                                    <label class="form-label">Tahun Terbit</label>
                                    <input type="number" id="inputTahun" th:field="*{tahunTerbit}" class="form-control" required>
                                </div>
                                <div class="col-md-4 mb-4">
                                    <label class="form-label">Jml Halaman</label>
                                    <input type="number" id="inputHalaman" th:field="*{halaman}" class="form-control">
                                </div>
                                <div class="col-md-4 mb-4">
                                    <label class="form-label">Kategori</label>
                                    <input type="text" id="inputKategori" th:field="*{kategori}" class="form-control">
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="form-label">Sinopsis / Deskripsi</label>
                                <textarea class="form-control" id="inputSinopsis" th:field="*{sinopsis}" rows="4"></textarea>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-4">
                                     <label class="form-label">Stok Fisik</label>
                                     <input type="number" th:field="*{stok}" class="form-control" required>
                                     <small class="text-muted">Jumlah buku yang tersedia di rak.</small>
                                </div>

                                <div class="col-md-6 mb-4">
                                     <label class="form-label">Cover Buku</label>
                                     
                                     <div class="d-flex align-items-center mb-3 p-2 border rounded bg-light" th:if="${buku.gambar != null}">
                                        <img th:src="${buku.gambar}" class="rounded me-3" style="height: 60px;">
                                        <small class="text-muted">Gambar saat ini</small>
                                     </div>

                                     <input type="file" name="fileGambar" class="form-control" accept="image/*">
                                     <input type="hidden" id="inputLinkCover" name="linkCover">
                                     
                                     <div class="mt-3 text-center p-3 border rounded bg-light" id="previewArea" style="display: none;">
                                         <small class="text-muted d-block mb-2">Preview dari Google:</small>
                                         <img id="imgPreview" src="" class="rounded shadow-sm" style="height: 120px;">
                                     </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-end gap-3 mt-4 pt-4 border-top">
                                <a href="/admin/buku" class="btn btn-secondary-soft">Batal</a>
                                <button type="submit" class="btn btn-primary-soft">
                                    <i class="fas fa-save me-2"></i>Simpan Data
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function cariBuku() {
            let isbn = document.getElementById("inputIsbn").value;
            if (!isbn) { alert("Masukkan nomor ISBN dulu!"); return; }

            let btn = document.querySelector(".btn-dark");
            let originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            fetch('/api/buku/cari-isbn?isbn=' + isbn)
                .then(response => {
                    if (!response.ok) throw new Error("Buku tidak ditemukan");
                    return response.json();
                })
                .then(data => {
                    document.getElementById("inputJudul").value = data.judul;
                    document.getElementById("inputPenulis").value = data.penulis;
                    document.getElementById("inputPenerbit").value = data.penerbit;
                    document.getElementById("inputTahun").value = data.tahun;
                    document.getElementById("inputHalaman").value = data.halaman;
                    document.getElementById("inputKategori").value = data.kategori;
                    document.getElementById("inputSinopsis").value = data.sinopsis || "";
                    
                    if (data.cover) {
                        document.getElementById("imgPreview").src = data.cover;
                        document.getElementById("previewArea").style.display = "block";
                        document.getElementById("inputLinkCover").value = data.cover;
                    }
                })
                .catch(error => { alert(error.message); })
                .finally(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
        }
    </script>
</body>
</html>