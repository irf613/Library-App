<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Kelola Transaksi - Admin</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-light">

    <div class="container py-5">
        <h2 class="mb-4 fw-bold">Kelola Transaksi</h2>

        <div class="card border-0 shadow-sm rounded-4">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="py-3 ps-4">ID</th>
                                <th>Peminjam</th>
                                <th>Buku</th>
                                <th>Tgl Pinjam/Booking</th>
                                <th>Tenggat</th>
                                <th>Status</th>
                                <th class="pe-4">Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="t : ${listTransaksi}">
                                <td class="ps-4 fw-bold" th:text="${t.id}">1</td>
                                <td>
                                    <span class="d-block fw-bold" th:text="${t.pengguna.namaLengkap}">User</span>
                                    <small class="text-muted" th:text="${t.pengguna.username}">@user</small>
                                </td>
                                <td>
                                    <span class="d-block fw-bold" th:text="${t.detailPeminjamanList[0].buku.judul}">Judul</span>
                                </td>
                                <td th:text="${t.tanggalPinjam}">2023-01-01</td>
                                <td th:text="${t.tenggatWaktu}">2023-01-08</td>
                                <td>
                                    <span th:if="${t.status == 'DIBOOKING'}" class="badge bg-warning text-dark">Booking</span>
                                    <span th:if="${t.status == 'DIPINJAM'}" class="badge bg-primary">Dipinjam</span>
                                    <span th:if="${t.status == 'DIKEMBALIKAN'}" class="badge bg-success">Selesai</span>
                                    <span th:if="${t.status == 'DIBATALKAN'}" class="badge bg-danger">Batal</span>
                                </td>
                                <td class="pe-4">
                                    
                                    <button th:if="${t.status == 'DIBOOKING'}" 
                                            type="button" 
                                            class="btn btn-sm btn-primary rounded-pill px-3 fw-bold"
                                            th:onclick="'bukaModalAmbil(' + ${t.id} + ')'">
                                        <i class="fas fa-hand-holding me-1"></i> Diambil
                                    </button>

                                    <form th:if="${t.status == 'DIPINJAM'}" th:action="@{/admin/transaksi/selesai}" method="post" class="d-inline">
                                        <input type="hidden" name="id" th:value="${t.id}">
                                        <button type="submit" class="btn btn-sm btn-success rounded-pill px-3 fw-bold" onclick="return confirm('Buku sudah dikembalikan?')">
                                            <i class="fas fa-check me-1"></i> Kembali
                                        </button>
                                    </form>

                                    <span th:if="${t.status == 'DIKEMBALIKAN'}" class="text-muted small"><i class="fas fa-lock"></i></span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalAmbilBuku" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 border-0 shadow">
                <div class="modal-header border-bottom-0 pb-0">
                    <h5 class="modal-title fw-bold">Konfirmasi Pengambilan Buku</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <form th:action="@{/admin/transaksi/ambil}" method="post">
                    <div class="modal-body">
                        <input type="hidden" name="id" id="inputIdTransaksi">
                        
                        <div class="alert alert-info small border-0 mb-3">
                            <i class="fas fa-info-circle me-1"></i> Status akan berubah menjadi <b>DIPINJAM</b>.
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold small text-muted">Tanggal Wajib Kembali</label>
                            <input type="date" name="tenggatWaktu" id="inputTenggat" class="form-control" required>
                            <div class="form-text">Secara default diset 7 hari dari hari ini.</div>
                        </div>
                    </div>
                    <div class="modal-footer border-top-0 pt-0">
                        <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Batal</button>
                        <button type="submit" class="btn btn-primary rounded-pill px-4 fw-bold">Simpan & Proses</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        function bukaModalAmbil(idTransaksi) {
            // 1. Masukkan ID ke input hidden di dalam modal
            document.getElementById('inputIdTransaksi').value = idTransaksi;

            // 2. Set Default Tanggal (Hari ini + 7 Hari)
            var date = new Date();
            date.setDate(date.getDate() + 7); // Tambah 7 hari
            var dateString = date.toISOString().split('T')[0]; // Format jadi YYYY-MM-DD
            
            document.getElementById('inputTenggat').value = dateString;

            // 3. Tampilkan Modal
            var myModal = new bootstrap.Modal(document.getElementById('modalAmbilBuku'));
            myModal.show();
        }
    </script>

</body>
</html>