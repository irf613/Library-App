<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="${buku.judul}">Detail Buku</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f9f9f9;
            color: #333;
            overflow-x: hidden;
        }

        /* --- NAVBAR --- */
        .navbar { border-bottom: 1px solid #eee; background: white; }
        .nav-link { font-weight: 600; color: #555; }

        /* --- HERO SECTION --- */
        .hero-section {
            background-color: #eef2f5;
            position: relative;
            min-height: 600px; 
            display: flex;
            align-items: center;
            overflow: hidden;
            margin-bottom: 50px;
        }

        .hero-bg-right {
            position: absolute; top: 0; right: 0; width: 45%; height: 100%; z-index: 0;
        }

        .hero-content {
            position: relative; z-index: 1; width: 100%; padding: 0 5%;
        }

        /* Teks & Tombol */
        .book-title { font-size: 3rem; font-weight: 800; line-height: 1.2; color: #222; margin-bottom: 15px; }
        .book-subtitle { font-size: 1.1rem; color: #555; margin-bottom: 30px; }
        .price-label { font-size: 0.9rem; color: #666; font-weight: 600; }
        .price-value { font-size: 1.8rem; font-weight: 800; color: #333; margin-bottom: 20px; display: block; }
        
        .btn-pinjam {
            background-color: #e65100; color: white; padding: 12px 30px;
            font-weight: 600; border-radius: 50px; border: none;
            display: inline-flex; align-items: center; gap: 10px;
            transition: 0.3s; text-decoration: none;
        }
        .btn-pinjam:hover { background-color: #bf360c; color: white; }
        .btn-pinjam.disabled { background-color: #ccc; cursor: not-allowed; pointer-events: none; }

        /* --- BUKU 3D REALISTIS --- */
        .book-image-container {
            display: flex; justify-content: center; perspective: 2000px; padding: 40px 0;
        }
        
        .book-3d-wrapper {
            position: relative; width: 320px; height: 480px; 
            transform-style: preserve-3d;
            transform: rotateY(-30deg) rotateX(5deg); 
            transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1), box-shadow 0.6s ease;
            box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.5); 
        }

        .book-3d-wrapper:hover {
            transform: rotateY(0deg) rotateX(0deg) scale(1.02);
            box-shadow: 0 20px 40px -5px rgba(0, 0, 0, 0.4); 
        }

        .book-front {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover; background-position: center; background-repeat: no-repeat;
            border-radius: 2px 4px 4px 2px; backface-visibility: hidden;
        }

        /* KERTAS SAMPING WARNA KREM */
        .book-3d-wrapper::before {
            content: ''; position: absolute; top: 0; left: 100%; width: 50px; height: 100%;
            background: linear-gradient(to right, #f8f5e1 0%, #eaddc5 10%, #f8f5e1 20%, #eaddc5 30%, #f8f5e1 40%, #eaddc5 50%, #f8f5e1 60%, #eaddc5 70%, #f8f5e1 80%, #eaddc5 90%, #f8f5e1 100%);
            border-top: 1px solid #d4c5a9; border-bottom: 1px solid #d4c5a9;
            transform-origin: left; transform: rotateY(90deg);
        }

        /* COVER BELAKANG WARNA KREM */
        .book-3d-wrapper::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #f8f5e1; transform: translateZ(-50px);
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
        }

        /* --- CARD STYLE --- */
        .gramedia-card {
            background-color: #ffffff; border: 1px solid #e0e0e0; border-radius: 16px;
            padding: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            transition: all 0.3s ease; position: relative; cursor: pointer;
            display: flex; flex-direction: column; height: 100%;
        }
        .gramedia-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); border-color: #b0c4de; }

        .book-cover-container {
            position: relative; overflow: hidden;
            aspect-ratio: 2/3; margin-bottom: 12px;
        }
        .book-cover { width: 100%; height: 100%; object-fit: cover; }
        .book-info { flex-grow: 1; display: flex; flex-direction: column; }
        .book-author { font-size: 0.75rem; color: #999; text-transform: uppercase; font-weight: 700; margin-bottom: 4px; }
        .book-title-card {
            font-weight: 800; font-size: 1rem; line-height: 1.4; margin-bottom: 8px; color: #2c3e50;
            display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
        }
        .book-category {
            font-size: 0.75rem; color: #007bff; background: #eef7ff;
            padding: 4px 10px; border-radius: 6px; display: inline-block;
            font-weight: 600; align-self: flex-start; margin-top: auto;
        }

        /* STEMPEL & GRAYSCALE */
        .stamp-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80%; z-index: 10; opacity: 0.9; pointer-events: none;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        .grayscale { filter: grayscale(100%) contrast(0.8); opacity: 0.7; }

        /* --- METADATA GRID --- */
        .meta-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px; margin-bottom: 50px; }
        @media (min-width: 992px) { .meta-grid { grid-template-columns: repeat(3, 1fr); } }
        .meta-item { display: flex; gap: 15px; }
        .meta-icon {
            width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            border: 1px solid #ddd; border-radius: 8px;
            color: #333; font-size: 1.2rem;
        }
        .meta-label { font-size: 0.85rem; color: #777; font-weight: 600; display: block; }
        .meta-value { font-size: 1rem; color: #333; font-weight: 500; }

        /* --- DESKRIPSI --- */
        .desc-title { font-weight: 700; margin-bottom: 15px; font-size: 1.2rem; }
        .desc-text { color: #555; line-height: 1.8; text-align: justify; }

    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-light bg-white sticky-top shadow-sm container-fluid px-lg-5">
        <a class="navbar-brand fw-bold text-primary" href="/katalog">
            <i class="fas fa-arrow-left me-2"></i> Kembali ke Katalog
        </a>
    </nav>

    <div class="hero-section">
        <div class="hero-bg-right"></div>
        
        <div class="container hero-content">
            <div class="row align-items-center">
                
                <div class="col-lg-6 pe-lg-5">
                    <h1 class="book-title" th:text="${buku.judul}">Judul Buku</h1>
                    
                    <div class="book-subtitle">
                        Penulis: <span th:text="${buku.penulis}" class="fw-bold text-dark">Penulis</span> <br>
                        Penerbit: <span th:text="${buku.penerbit}">Penerbit</span>
                    </div>

                    <div class="mt-4">
                        <span class="price-label">Biaya Pinjam</span>
                        <span class="price-value">Gratis / Free</span>
                    </div>

                    <div class="mt-4">
                        
                        <div th:if="${sedangDibookingUser}">
                            <form th:action="@{/booking/cancel}" method="post">
                                <input type="hidden" name="bukuId" th:value="${buku.id}" />
                                <button type="submit" class="btn btn-outline-danger rounded-pill px-4 py-2 fw-bold">
                                    <i class="fas fa-times me-2"></i> Batalkan Booking
                                </button>
                            </form>
                            <p class="text-muted mt-2 small">
                                <i class="fas fa-info-circle me-2"></i> Kamu sudah membooking buku ini.
                            </p>
                        </div>

                        <div th:unless="${sedangDibookingUser}">

                            <div th:if="${buku.sedangDipinjam}">
                                 <button class="btn btn-danger rounded-pill px-4 py-2" disabled>
                                    <i class="fas fa-lock me-2"></i> Sedang Dipinjam
                                </button>
                                <p class="text-muted mt-2 small">
                                    <i class="fas fa-info-circle me-2"></i> Buku ini sedang dibawa anggota lain.
                                </p>
                            </div>

                            <div th:if="${!buku.sedangDipinjam && buku.stok > 0}">
                                <form th:action="@{/booking}" method="post">
                                    <input type="hidden" name="bukuId" th:value="${buku.id}" />
                                    <button type="submit" class="btn btn-primary rounded-pill px-4 py-2 fw-bold shadow-sm">
                                        <i class="fas fa-bookmark me-2"></i> Booking Sekarang
                                    </button>
                                </form>
                                <p class="text-muted mt-2 small">
                                    <i class="fas fa-info-circle me-2"></i> Amankan stok buku ini sebelum diambil orang lain.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="book-image-container">
                        <div class="book-3d-wrapper">
                            <div class="book-front" th:style="'background-image: url(' + ${buku.gambar} + ');'"></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="container pb-5">
        <div class="row">
            <div class="col-12"> 
                <div class="meta-grid">
                    <div class="meta-item">
                        <div class="meta-icon"><i class="fas fa-barcode"></i></div>
                        <div><span class="meta-label">ISBN</span><span class="meta-value" th:text="${buku.isbn ?: '-'}">-</span></div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-icon"><i class="fas fa-building"></i></div>
                        <div><span class="meta-label">Penerbit</span><span class="meta-value" th:text="${buku.penerbit}">-</span></div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-icon"><i class="fas fa-pen-nib"></i></div>
                        <div><span class="meta-label">Penulis</span><span class="meta-value" th:text="${buku.penulis}">-</span></div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-icon"><i class="far fa-calendar-alt"></i></div>
                        <div><span class="meta-label">Tahun Terbit</span><span class="meta-value" th:text="${buku.tahunTerbit}">-</span></div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-icon"><i class="fas fa-book-open"></i></div>
                        <div><span class="meta-label">Jumlah Halaman</span><span class="meta-value" th:text="${buku.halaman + ' Hal'}">0 Hal</span></div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-icon"><i class="fas fa-bookmark"></i></div>
                        <div><span class="meta-label">Kategori</span><span class="meta-value" th:text="${buku.kategori}">-</span></div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-icon"><i class="fas fa-check-circle"></i></div>
                        <div>
                            <span class="meta-label">Status</span>
                            <span class="meta-value text-success" th:if="${!buku.sedangDipinjam}">Tersedia <span th:text="${buku.stok}"></span> Buku</span>
                            <span class="meta-value text-danger" th:if="${buku.sedangDipinjam}">Habis Dipinjam</span>
                        </div>
                    </div>
                </div>
                <hr class="my-5">
                <div class="description-section">
                    <h4 class="desc-title"><i class="fas fa-align-left me-2"></i>Deskripsi Buku</h4>
                    <p class="desc-text"><span th:text="${buku.sinopsis != null ? buku.sinopsis : 'Belum ada deskripsi detail untuk buku ini.'}"></span></p>
                </div>
            </div>
        </div>
    </div>

    <div class="container pb-5 mb-5" th:if="${rekomendasi != null && !rekomendasi.isEmpty()}">
        <h4 class="desc-title mb-4">Mungkin Kamu Suka</h4>
        <div class="row row-cols-2 row-cols-md-4 g-4">
            <div class="col" th:each="rek : ${rekomendasi}">
                <a th:href="@{/buku/{id}(id=${rek.id})}" class="text-decoration-none text-dark h-100">
                    <div class="gramedia-card">
                        <div class="book-cover-container bg-light">
                            <img th:if="${rek.sedangDipinjam}" src="/images/stempel.png" class="stamp-overlay" alt="Dipinjam">
                            <img th:src="${rek.gambar}" class="book-cover" th:classappend="${rek.sedangDipinjam} ? 'grayscale'" alt="Cover">
                        </div>
                        <div class="book-info">
                            <div class="book-author" th:text="${rek.penulis}">Penulis</div>
                            <div class="book-title-card" th:text="${rek.judul}">Judul</div>
                            <div class="mt-auto pt-2"><span class="book-category" th:text="${rek.kategori}">Kategori</span></div>
                        </div>
                    </div>
                </a>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script th:inline="javascript">
        /*<![CDATA[*/
        // 1. Ambil parameter dari URL
        var suksesParam = /*[[${param.sukses}]]*/ null;
        var gagalParam = /*[[${param.gagal}]]*/ null;

        // 2. Logic Alert Sukses
        if (suksesParam) {
            var status = Array.isArray(suksesParam) ? suksesParam[0] : suksesParam;

            if (status === 'booking') {
                alert("✅ BOOKING BERHASIL!\n\nStok buku sudah diamankan.\nSilakan ambil buku di meja admin dalam waktu 1x24 jam.");
            } else if (status === 'batal') {
                alert("ℹ️ BOOKING DIBATALKAN.\n\nStok buku telah dikembalikan.");
            }
        }

        // 3. Logic Alert Gagal
        if (gagalParam) {
            var error = Array.isArray(gagalParam) ? gagalParam[0] : gagalParam;

            if (error === 'stok_habis') {
                alert("❌ GAGAL: Stok buku baru saja habis.");
            } else if (error === 'sudah_ada') {
                alert("⚠️ GAGAL: Kamu sudah membooking atau meminjam buku ini.");
            } else {
                alert("❌ Terjadi kesalahan saat memproses booking.");
            }
        }

        // 4. FITUR BARU: Hapus Parameter URL setelah Alert muncul
        // Ini biar pas di-refresh, alert gak muncul lagi
        if (suksesParam || gagalParam) {
            // Ambil URL tanpa query string (misal: http://localhost:8080/buku/1)
            var cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
            
            // Update Address Bar browser tanpa reload halaman
            window.history.replaceState({path: cleanUrl}, '', cleanUrl);
        }
        /*]]>*/
    </script>
</body>
</html>